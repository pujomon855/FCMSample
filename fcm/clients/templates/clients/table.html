{% extends 'clients/base.html' %}
{% load static %}
{% block title %}Client Table{% endblock %}

{% block head %}
<link rel="stylesheet" type="text/css" href="{% static 'clients/css/table.css' %}"/>
<script type="text/javascript">
    'use strict';

    function escapeSelectorString(val) {
        return val.replace(/[ !"#$%&'()*+,.\/:;<=>?@\[\\\]^`{|}~]/g, "\\$&");
    }

    // Returns JQuery object
    function getSearchRow(colName) {
        return $('#client-table thead th#search-' + escapeSelectorString(colName));
    }

    $(function() {
        // Create header
        let searchRow = $('#search-row');
        let colNameRow = $('#col-name-row');
        {% for col_name, col_group in columns %}
            searchRow.append(
                $("<th></th>", {
                    id: "search-" + "{{ col_name }}",
                }).append(
                    $("<input>", {
                        type: "text",
                        placeholder: "Search " + "{{ col_name }}",
                    })
                )
            );
            colNameRow.append(
                $("<th></th>", {
                    "class": "{{ col_group.grp_class }}",
                }).text("{{ col_name }}")
            );
        {% endfor %}

        // DataTable
        let table = $('#client-table').DataTable({
            stateSave: true,
            colReorder: true,
        });

        // Apply the search to every column
        $('#search-row input').on('keyup change clear', function() {
            // get search method
            let isRegex = ($('div#search-method input[name=searchMethod]:checked').val() === 'regex');

            table
                .column($(this).parent().index()+':visible')
                .search(this.value, isRegex)
                .draw();
        });

        // Register columns' show hide event by their group
        let hideColGrpCls = 'hide-col-grp';
        $('#table-ope-row1 div.ope-item button.sh-groups').on('click', function(event) {
            let $btn = $(this);
            $btn.toggleClass(hideColGrpCls);
            let grp_class = $btn.data('grp_class');
            // If the button has this class, the columns of the group of this button should be invisible.
            let isVisible = !$btn.hasClass(hideColGrpCls);
            $('#client-table').DataTable().columns('.' + grp_class).visible(isVisible);
        });
    });

    function openColumnChooser() {
        // Classify columns by visible state
        let shownCols = [];
        let hiddenCols = [];
        $('#client-table').DataTable().columns().every(function() {
            if (this.visible()) {
                shownCols.push(this);
            } else {
                hiddenCols.push(this);
            }
        });

        // Append column names to dialog
        function createColNameHTML(id, cols) {
            let ul = $('#' + id);
            ul.children().remove();
            for (let i in cols) { // for of cannot be applied to IE...
                let col = cols[i];
                ul.append($('<li></li>')
                    .addClass('col-name')
                    .data('col-idx', col.index())
                    .text(col.header().innerHTML));
            }
        }
        createColNameHTML('shown-cols', shownCols);
        createColNameHTML('hidden-cols', hiddenCols);

        // Columns to sortable
        $('#hidden-cols, #shown-cols').sortable({
            connectWith: '.connectedSortable'
        }).disableSelection();

        // Open Column Chooser
        $('[data-remodal-id=modal]').remodal().open();
    }

    function clearSearchInput(colName) {
        let searchInput = getSearchRow(colName).children('input');
        if (searchInput.val() !== '') {
            searchInput.val('').change(); // Reset filtering by this column
        }
    }

    // Update columns' visible state and order when apply button pressed
    $(document).on('confirmation', '.remodal', function() {
        // Returns array of col-idx
        function getColIdxFromChooser(id) {
            let colIndexes = [];
            $('#' + id).children().each(function(idx, elem) {
                colIndexes.push($(elem).data('col-idx'));
            });
            return colIndexes;
        }
        let shownColIndexes = getColIdxFromChooser('shown-cols');
        let hiddenColIndexes = getColIdxFromChooser('hidden-cols');

        // Visible state
        let table = $('#client-table').DataTable();
        table.columns(shownColIndexes).visible(true);
        table.columns(hiddenColIndexes).every(function() {
            clearSearchInput(this.header().innerHTML);
        }).visible(false);

        // Order
        table.colReorder.order(shownColIndexes.concat(hiddenColIndexes));
    });

    function showAll(event) {
        $('#client-table').DataTable().columns().visible(true);
    }

    window.addEventListener('beforeunload', function(event) {
        // Clear search inputs before user leave this page
        $('#client-table').DataTable().columns().every(function() {
            clearSearchInput(this.header().innerHTML);
        });
    });


</script>
{% endblock %}

{% block contents %}
<h3>Client Table</h3>
<div>
    <div id="table-ope-row1">
        <div id="search-method" class="ope-item">
            <p>検索方法：
                <input type="radio" name="searchMethod" value="normal" checked>通常
                <input type="radio" name="searchMethod" value="regex">正規表現
            </p>
        </div>
        <!--Column Chooser Dialog-->
        <div class="remodal" data-remodal-id="modal">
            <button data-remodal-action="close" class="remodal-close"></button>
            <div class="modal-title"><b>Column Chooser</b></div>
            <div class="modal-body">
                <div class="left">
                    <fieldset>
                        <legend>Hidden</legend>
                        <input type="text" placeholder="Search column">
                        <div class="col-area">
                            <ul id="hidden-cols" class="connectedSortable col-names">

                            </ul>
                        </div>
                    </fieldset>
                </div>
                <div class="center">

                </div>
                <div class="right">
                    <fieldset>
                        <legend>Shown</legend>
                        <input type="text" placeholder="Search column">
                        <div class="col-area">
                            <ul id="shown-cols" class="connectedSortable col-names">

                            </ul>
                        </div>
                    </fieldset>
                </div>
            </div>
            <div class="modal-footer">
                <button data-remodal-action="confirm" class="remodal-confirm">Apply</button>
                <button data-remodal-action="cancel" class="remodal-cancel">Cancel</button>
            </div>
        </div>
        <div id="ope-buttons" class="ope-item">
            <div><button type="button" onclick="openColumnChooser()">Column Chooser</button></div>
            <div><button type="button" onclick="showAll()">Show All</button></div>
            {% if col_groups %}
                {% for col_group in col_groups %}
                    <div><button type="button" class="{{ col_group.grp_class }} sh-groups"
                            data-grp_class="{{ col_group.grp_class }}">{{ col_group.name }}</button></div>
                {% endfor %}
            {% endif %}
        </div>
    </div>
    <div>
        <table id="client-table" border="1">
            <thead>
                <tr id="search-row"></tr>
                <tr id="col-name-row"></tr>
            </thead>
            <tbody>
                {% if client_list %}
                    {% for client in client_list %}
                        <tr>
                            {% for item, link in client %}
                                {% if link %}
                                    <td><a href="{% url link.url link.args %}">{{ item }}</a></td>
                                {% else %}
                                    <td>{{ item }}</td>
                                {% endif %}
                            {% endfor %}
                        </tr>
                    {% endfor %}
                {% endif %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
